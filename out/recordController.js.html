<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: recordController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: recordController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module Record
 */
const mongoose = require('mongoose')
const Record = mongoose.model('Record')
const passport = require('passport')
const User = mongoose.model('User')
const Contact = mongoose.model('Contact')
const { populate } = require('../models/recordSchema')

require('../config/passport')(passport);


/**
* create a new Record Function
* @param {express.Request} req - information json for add a record
* @param {express.Response} res - response from the system.
*/
const createRecord = async (req, res) => {
    /*
    request header: user
    request body:
    {  
        "contact_id": 12354325
        "dateTime": "2000/10/10",
        "location": "University of Melbourne",
        "note": "the notes",
        "linkedAccount": "account",
        "ownerAccount" : "ownerAccount"
    }*/
    try {
        const {contact_id, dateTime, location, note, linkedAccount} = req.body
        if (dateTime==null) {
            dateTimeOut = new Date.now()
        } else {
            dateTimeOut = new Date(dateTime)
        } 
        
        //meetingPerson = await Contact.findOne({_id: mongoose.Types.ObjectId(contact_id)}).lean()
        newRecord = await Record.create({
            "meetingPerson": contact_id,
            "dateTime": dateTimeOut,
            "location": location,
            "note": note,
            "linkedAccount" : linkedAccount,
            "ownerAccount" : req.user._id
        })
        await newRecord.save()
        await User.findOneAndUpdate(
            { _id: req.user._id }, 
            { $push: { 
                recordList: newRecord._id
            } 
            })
        res.send("Record Create Successfully")
    }catch(err){
        res.send("Database query failed")
    }
}


/**
* show All Records for the user
* @param {express.Request} req 
* @param {express.Response} res - response from the system.
*/
const showAllRecords = async (req,res) => {
    const ownerAccount = await User.findOne({_id: mongoose.Types.ObjectId(req.user._id)}).lean()
    const recordListIds = ownerAccount.recordList;
    recordList = new Array();
    var order;
    for (order in recordListIds) {
        record = await Record.findOne({_id: mongoose.Types.ObjectId(recordListIds[order])}).populate("meetingPerson").populate("linkedAccount").lean()
        recordList.push(record)
    }
    if(recordList != null) res.json(recordList)
}

const searchRecord = async (req, res) => {
    const validationErrors = expressValidator.validationResult(req)
    if (!validationErrors.isEmpty()){
        return res.status(422).render('error', {errorCode: '422', message: 'Search works on alphabet characters only.'})
    }
    var query = {}

    if (req.body.meetingPerson != ''){
        query["meetingPerson"] = {$regex: new RegExp(req.body.meetingPerson, 'i') }
    }
    if (req.body.location != ''){
        query["location"] = {$regex: new RegExp(req.body.location, 'i') }
    }
    if (req.body.occupation != ''){
        query["occupation"] = {$regex: new RegExp(req.body.occupation, 'i') }
    }
    if (req.body.dateTime != ''){
        try {
            const searchDate = new Date(req.body.dateTime)
            var matchRecords = await Record.find({dateTime: {$lt: searchDate.getTime()}})
            res.json(matchRecords)
            return
        } catch (err) {
            console.log(err)
        }
    }
    try {
		const records = await Record.find(query).lean()
		res.json(records)	
	} catch (err) {
		console.log(err)
	}
}


module.exports = {
    createRecord,
    showAllRecords,
    searchRecord
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Contact.html">Contact</a></li><li><a href="module-profile.html">profile</a></li><li><a href="module-Record.html">Record</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Thu Sep 30 2021 18:25:03 GMT+1000 (Australian Eastern Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
